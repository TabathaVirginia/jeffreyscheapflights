
<!doctype html>

<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <!-- JQuery -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
    <script src="PapaParse-4.6.0/papaparse.js"></script>


    <title>Database Seed Script</title>


    <!-- JavaScript to operate the requests -->
    <script>
        $(function() {
            // Login credentials
            const credentials = {
                username: 'tabathav',
                password: '730010609',
            };


            // Airlines
            const airlines = [
                // fill with airlines
            ];


            const airports = [];
//            [{
//                name: 'Boston Logan International Airport',
//                code: 'BOS',
//                city: 'Boston',
//                state: 'MA',
//            }, {
//                name: 'Raleigh Durham International Airport',
//                code: 'RDU',
//                city: 'Raleigh',
//                state: 'NC',
//            }, {
//                name: 'Charlotte Douglas International Airport',
//                code: 'CLT',
//                city: 'Charlotte',
//                state: 'NC',
//            }];


            // Flights
            const flights = [
                // fill with flights
            ];


            // Instances
            const instances = [
                // fill with instances
            ];


            // Itineraries
            const itineraries = [
                // fill with itineraries
            ];


            // Seats
            const seats = [];
                // fill with seats
//            {
//                "plane_id":  2,
//                "row":       21,
//                "number":    "A",
//                "cabin":     "economy",
//                "is_window": true,
//                "is_aisle": false,
//                "is_exit": false,
//                "info": ""
//            }

            
//            let id = 2229;
//            for(let i = 0; i < 11; i++){
//                seats[seats.length] = {
//                    "plane_id":  id + i,
//                    "row":       21,
//                    "number":    "A",
//                    "cabin":     "economy",
//                    "is_window": true,
//                    "is_aisle": false,
//                    "is_exit": false,
//                    "info": ""
//                };
//                seats[seats.length] = {
//                    "plane_id":  id + i,
//                    "row":       30,
//                    "number":    "A",
//                    "cabin":     "economy",
//                    "is_window": true,
//                    "is_aisle": false,
//                    "is_exit": false,
//                    "info": ""
//                };
//                seats[seats.length] = {
//                    "plane_id":  id + i,
//                    "row":       11,
//                    "number":    "A",
//                    "cabin":     "economy",
//                    "is_window": true,
//                    "is_aisle": false,
//                    "is_exit": false,
//                    "info": ""
//                };
//                seats[seats.length] = {
//                    "plane_id":  id + i,
//                    "row":       2,
//                    "number":    "A",
//                    "cabin":     "business",
//                    "is_window": true,
//                    "is_aisle": false,
//                    "is_exit": false,
//                    "info": ""
//                };
//                seats[seats.length] = {
//                    "plane_id":  id + i,
//                    "row":       21,
//                    "number":    "A",
//                    "cabin":     "economy",
//                    "is_window": true,
//                    "is_aisle": false,
//                    "is_exit": false,
//                    "info": ""
//                };
//                seats[seats.length] = {
//                    "plane_id":  id + i,
//                    "row":       24,
//                    "number":    "B",
//                    "cabin":     "economy",
//                    "is_window": false,
//                    "is_aisle": false,
//                    "is_exit": false,
//                    "info": ""
//                };
//                    
//                seats[seats.length] = {
//                    "plane_id":  id + i,
//                    "row":       17,
//                    "number":    "C",
//                    "cabin":     "economy",
//                    "is_window": false,
//                    "is_aisle": false,
//                    "is_exit": false,
//                    "info": ""
//                };
//                seats[seats.length] = {
//                    "plane_id":  id + i,
//                    "row":       17,
//                    "number":    "D",
//                    "cabin":     "economy",
//                    "is_window": false,
//                    "is_aisle": true,
//                    "is_exit": false,
//                    "info": ""
//                };
//                seats[seats.length] = {
//                    "plane_id":  id + i,
//                    "row":       17,
//                    "number":    "D",
//                    "cabin":     "economy",
//                    "is_window": false,
//                    "is_aisle": true,
//                    "is_exit": false,
//                    "info": ""
//                };
//                seats[seats.length] = {
//                    "plane_id":  id + i,
//                    "row":       18,
//                    "number":    "D",
//                    "cabin":     "economy",
//                    "is_window": false,
//                    "is_aisle": true,
//                    "is_exit": false,
//                    "info": ""
//                };
//                seats[seats.length] = {
//                    "plane_id":  id + i,
//                    "row":       19,
//                    "number":    "D",
//                    "cabin":     "economy",
//                    "is_window": false,
//                    "is_aisle": true,
//                    "is_exit": false,
//                    "info": ""
//                };
//                seats[seats.length] = {
//                    "plane_id":  id + i,
//                    "row":       10,
//                    "number":    "D",
//                    "cabin":     "economy",
//                    "is_window": false,
//                    "is_aisle": false,
//                    "is_exit": true,
//                    "info": ""
//                };
//                seats[seats.length] = {
//                    "plane_id":  id + i,
//                    "row":       23,
//                    "number":    "D",
//                    "cabin":     "economy",
//                    "is_window": false,
//                    "is_aisle": false,
//                    "is_exit": true,
//                    "info": ""
//                };
//                seats[seats.length] = {
//                    "plane_id":  id + i,
//                    "row":       23,
//                    "number":    "C",
//                    "cabin":     "economy",
//                    "is_window": true,
//                    "is_aisle": false,
//                    "is_exit": true,
//                    "info": ""
//                };
//                 seats[seats.length] = {
//                    "plane_id":  id + i,
//                    "row":       23,
//                    "number":    "B",
//                    "cabin":     "economy",
//                    "is_window": false,
//                    "is_aisle": true,
//                    "is_exit": true,
//                    "info": ""
//                };
//            }


            // Tickets
            const tickets = [
                // fill with tickets
            ];


            // Planes
            const planes = [
                // fill with planes
            ];
            
            
            
            
            
            
            
            let processData = function(results) {
                    //0: "id"
                    //1: "ident"
                    //2: "type"
                    //3: "name"
                    //4: "latitude_deg"
                    //5: "longitude_deg"
                    //6: "elevation_ft"
                    //7: "continent"
                    //8: "iso_country"
                    //9: "iso_region"
                    //10: "municipality"
                    //11: "scheduled_service"
                    //12: "gps_code"
                    //13: "iata_code"
                    //14: "local_code"
                    //15: "home_link"
                    //16: "wikipedia_link"
                    //17: "keywords"
                function array_location_map(){ 
                    this.name = 3;
                    this.iata_code = 13;
                    this.latitude_deg = 4;
                    this.longitude_deg = 5;
                    this.municipality = 10;
                    this.iso_region = 9;
                    this.iso_country = 8;
                };
                
                let map = new array_location_map();
                
                
                
                console.log("here");
                console.log("Synchronous results:", results);
                let data = results.data;
                console.log("Length:", data.length);
                for(let i = 1; i < data.length; i++){
//                     name, code,      latitude,     longitude,     city,         state,      city_url
//                     name, iata_code, latitude_deg, longitude_deg, municipality, iso_region, iso_country
//                     possible city -- Raleigh/Durham
//                     city_url is country
//                     iso_region - change US_NC to just NC?
                    
                    let record = data[i];
                    if(record[map.name] == "" || record[map.iata_code]  == "" || record[map.latitude_deg]  == "" || record[map.longitude_deg] == "" || record[map.municipality]  == "" || record[map.iso_region] == "" || record[map.iso_country] == "" || record[map.iata_code]  == 0){
                        continue;
                    }
                    airports[airports.length] = {
                        name: record[map.name],
                        code: record[map.iata_code],
                        latitude: record[map.latitude_deg],
                        longitude: record[map.longitude_deg],
                        city: record[map.municipality],
                        state: record[map.iso_region],
                        city_url: record[map.iso_country]
                    };
                }
                
                console.log(airports);
            }

            let config = {
                delimiter: "", // auto-detect
                newline: "", // auto-detect
                quoteChar: '"',
                escapeChar: '"',
                header: false,
                transformHeader: undefined,
                dynamicTyping: false,
                preview: 0,
                encoding: "",
                worker: false,
                comments: false,
                step: undefined,
                complete: function(results) {
                    processData(results);
                },
                error: undefined,
                download: false, // set to true for URL
                skipEmptyLines: false,
                chunk: undefined,
                fastMode: undefined,
                beforeFirstChunk: undefined,
                withCredentials: undefined,
                transform: undefined

            };

            
            let url = 'data/airports.csv';

            $.ajax({
                type: "GET",
                url: url,
                dataType: "text",
                success: function(data) {
                    Papa.parse(data, config);
                }
            });
            


            /**
             * Just a simple mapping from pluralized resource names to singular
             *   resource names.
             */
            const singularize = {
                airlines: 'airline',
                airports: 'airport',
                flights: 'flight',
                instances: 'instance',
                itineraries: 'itinerary',
                seats: 'seat',
                tickets: 'ticket',
                planes: 'plane',
            };


            /**
             * Logs in to the flights-api server.
             * 
             * @param username  The username of your flights-api account
             * @param password  The password for your flights-api account
             * @return  Returns a promise object that resolves once you are logged in
             */
            function login(username, password) {
                return $.ajax({
                    url: 'http://comp426.cs.unc.edu:3001/sessions',
                    type: 'POST',
                    data: {
                        user: {
                            username: username,
                            password: password,
                        },
                    },
                    xhrFields: {
                        withCredentials: true
                    },
                });
            }


            /**
             * Logs out of the flights-api server
             * 
             * @return  Returns a promise object that resolves once you are logged out
             */
            function logout() {
                return $.ajax({
                    url: 'http://comp426.cs.unc.edu:3001/sessions',
                    type: 'DELETE',
                    xhrFields: {
                        withCredentials: true
                    },
                });
            }


            /**
             * Clears the data in your database
             * 
             * @return  Returns a promise object that resolves once your data is cleared
             */
            function clear() {
                return $.ajax({
                    url: 'http://comp426.cs.unc.edu:3001/data',
                    type: 'DELETE',
                    xhrFields: {
                        withCredentials: true
                    },
                });
            }


            /**
             * Makes a series of ajax requests to seed the database with one type of resource
             * 
             * @param resourceName  The plural name of the resource as a string
             * @param dataArray     An array of data objects representing the fields to create
             * @return Returns a promise object that resolves once all requests have completed
             */
            function create(resourceName, dataArray) {
                let prom = $().promise(); // start with an empty promise
                dataArray.forEach(function(data) {
                    let wrappedData = {};
                    wrappedData[singularize[resourceName]] = data;
                    prom = prom.then(function() {
                        return $.ajax({
                            url: 'http://comp426.cs.unc.edu:3001/' + resourceName,
                            type: 'POST',
                            data: wrappedData,
                            xhrFields: {
                                withCredentials: true
                            },
                        });
                    });
                });
                return prom;
            }


            /**
             * Handle "Log In" button
             */
            $('#login-button').click(function() {
                $('#message').html('<strong class="text-muted">Logging in...</strong>');
                login(credentials.username, credentials.password).then(function() {
                    $('#message').html('<strong class="text-success">You are now logged in.</strong>');
                }).fail(function() {
                    $('#message').html('<strong class="text-danger">An error occurred.</strong>');
                });
            });


            /**
             * Handle "Clear Database" button
             */
            $('#clear-button').click(function() {
                if (confirm('Are you sure you want to clear your entire database?')) {
                    $('#message').html('<strong class="text-muted">Wiping database...</strong>');
                    clear().then(function() {
                        $('#message').html('<strong class="text-success">Your database has been cleared.</strong>');
                    }).fail(function() {
                        $('#message').html('<strong class="text-danger">An error occurred.</strong>');
                    });
                }
            });


            /**
             * Handle "Run Seed Script" button
             */
            let isRunning = false;
            $('#start-button').click(function() {
                if (isRunning) {
                    return;
                }
                isRunning = true;

                $('#message').html('<strong class="text-muted">Seeding database...</strong>');
                $().promise().then(function() {
                    return create('airlines', airlines);
                }).then(function() {
                    return create('airports', airports);
                }).then(function() {
                    return create('flights', flights);
                }).then(function() {
                    return create('instances', instances);
                }).then(function() {
                    return create('itineraries', itineraries);
                }).then(function() {
                    return create('seats', seats);
                }).then(function() {
                    return create('tickets', tickets);
                }).then(function() {
                    return create('planes', planes);
                }).then(function() {
                    $('#message').html('<strong class="text-success">Finished!</strong>');
                }).fail(function() {
                    $('#message').html('<strong class="text-danger">An error occurred.</strong>');
                }).always(function() {
                    isRunning = false;
                });
            });
        });
    </script>
</head>


<body>
    <p id="message" class="text-center mt-4 mb-4">
        <strong>Ready!</strong>
    </p>

    <p class="text-center">
        <button id="login-button" class="btn btn-primary">
            Log In
        </button>
    </p>

    <p class="text-center">
        <button id="clear-button" class="btn btn-danger">
            Clear Database
        </button>
    </p>

    <p class="text-center">
        <button id="start-button" class="btn btn-info">
            Run Seed Script
        </button>
    </p>
</body>
</html>
